#!/bin/bash

# Variables
GITLAB_API_URL="https://gitlab.example.com/api/v4"
PERSONAL_ACCESS_TOKEN="your_personal_access_token"
USER_ID="target_user_id"
ACCESS_LEVEL="20" # 20 = Reporter (read-only access)

# Get all projects in GitLab
projects=$(curl --header "PRIVATE-TOKEN: $PERSONAL_ACCESS_TOKEN" "$GITLAB_API_URL/projects?membership=true&per_page=100" | jq -r '.[].id')

# Iterate over each project and add the user as a Reporter
for project_id in $projects; do
  response=$(curl --request POST --header "PRIVATE-TOKEN: $PERSONAL_ACCESS_TOKEN" --header "Content-Type: application/json" \
  --data "{\"user_id\": $USER_ID, \"access_level\": $ACCESS_LEVEL}" \
  "$GITLAB_API_URL/projects/$project_id/members")
  
  # Check if the user was added successfully
  if echo "$response" | grep -q "created_at"; then
    echo "User $USER_ID added as Reporter to project $project_id."
  else
    echo "Failed to add user $USER_ID to project $project_id. Response: $response"
  fi
done
